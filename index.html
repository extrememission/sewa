<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spiritual Exercises Journal</title>
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="Exercises" />
    <link rel="manifest" href="/site.webmanifest" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&family=Source+Sans+3:ital,wght@0,200..900;1,200..900&display=swap" rel="stylesheet">
    <style>
        /* --- Basic Setup & Typography --- */
        :root {
            --primary-bg: #fdfaf5;
            --secondary-bg: #ffffff;
            --text-color: #3a3a3a;
            --heading-color: #1a2c42;
            --accent-color: #8a6d46;
            --border-color: #e0d9cf;
            --shadow-color: rgba(0, 0, 0, 0.05);
            --key-color: #c5a157;
        }

        html, body {
            height: 100%;
        }

        body {
            font-family: 'Source Sans 3', sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-color);
            margin: 0;
            line-height: 1.6;
            overflow: hidden;
            overscroll-behavior: none;
        }

        h1, h2, h3, h4 {
            font-family: 'Lora', serif;
            color: var(--heading-color);
            font-weight: 600;
        }

        /* --- Main Layout (App Container) --- */
        .app-container {
            display: flex;
            height: 100%;
            overflow: hidden;
        }

        /* --- Sidebar (Navigation) --- */
        .sidebar {
            width: 320px;
            background-color: var(--secondary-bg);
            border-right: 1px solid var(--border-color);
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 15px var(--shadow-color);
            transition: transform 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }

        .sidebar-header { text-align: center; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; }
        .sidebar-header h2 { margin: 0; font-size: 1.5rem; }
        .sidebar-header p { font-size: 0.9rem; color: #777; margin: 5px 0 0; }

        .data-management-buttons { display: flex; flex-wrap: wrap; justify-content: space-around; gap: 10px; padding: 10px 0; border-bottom: 1px solid var(--border-color); margin-bottom: 10px; }
        .io-button { background: #f7f3ed; border: 1px solid var(--border-color); color: var(--accent-color); padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: background-color 0.2s; flex-basis: 45%; text-align: center;}
        .io-button:hover { background-color: #f0ebe4; }
        #home-button, #keys-button { background-color: var(--accent-color); color: white; }
        #home-button:hover, #keys-button:hover { background-color: #6d5635; }
        #help-button {
            background: none;
            border: none;
            color: var(--accent-color);
            cursor: pointer;
            font-size: 1.5rem;
            padding: 10px;
            margin-top: 10px;
            width: 100%;
        }
        #help-button:hover { color: #6d5635; }


        #navigation-menu { flex-grow: 1; }

        /* Accordion Styles */
        .category-list h3 { margin-top: 15px; margin-bottom: 0; font-size: 1.1rem; color: var(--accent-color); padding: 10px; cursor: pointer; border-radius: 6px; transition: background-color 0.2s; position: relative; }
        .category-list h3::after { content: '+'; position: absolute; right: 15px; font-weight: bold; }
        .category-list.open > h3::after { content: 'âˆ’'; }
        .category-list.open > h3 { background-color: #f0ebe4; }
        
        .exercise-list { list-style: none; padding: 0; margin: 0; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-in-out; }
        .category-list.open .exercise-list { max-height: 1000px; }
        .exercise-list-item a { display: block; padding: 10px 15px 10px 25px; text-decoration: none; color: var(--text-color); border-radius: 6px; margin-bottom: 5px; transition: background-color 0.2s, color 0.2s; font-weight: 500; }
        .exercise-list-item a:hover { background-color: #f0ebe4; }
        .exercise-list-item a.active { background-color: var(--accent-color); color: white; font-weight: 700; }
        .exercise-list-item { display: flex; align-items: center; }
        .exercise-list-item a { flex-grow: 1; }
        .exercise-list-item .key-toggle-nav { margin-right: 10px; accent-color: var(--key-color); }
        
        /* --- Main Content Area --- */
        .main-content { 
            flex-grow: 1; 
            padding: 40px; 
            overflow-y: auto; 
            min-height: 0;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }
        .welcome-view, .exercise-view, .keys-view { max-width: 800px; margin: 0 auto; }
        
        /* Welcome & Keys View Styles */
        .welcome-view, .keys-view { text-align: center; padding-top: 5vh; }
        .welcome-view h1, .keys-view h1 { font-size: 2.5rem; }
        .welcome-view p { font-size: 1.2rem; color: #555; }
        
        #welcome-header .cursor {
            display: inline-block;
            background-color: var(--heading-color);
            margin-left: 0.1rem;
            width: 3px;
            animation: blink 1s infinite;
        }
        #animated-text-wrapper.deleting {
            background-color: #ffe8c8;
            border-radius: 4px;
        }
        @keyframes blink { 50% { background-color: transparent; } }

        #name-prompt { text-align: center; }
        #name-prompt p { margin-bottom: 15px; }
        #name-prompt input { 
            display: block;
            margin: 0 auto 15px auto;
            font-size: 1.1rem; 
            padding: 10px; 
            border-radius: 6px; 
            border: 1px solid var(--border-color); 
            width: 300px; 
            text-align: center; 
        }
        #name-prompt button { font-size: 1.1rem; padding: 10px 20px; }
        #keys-section { margin-top: 40px; text-align: left; }
        .keys-description { margin: 0 0 10px 0; color: #555; font-size: 1rem; }
        #keys-list { list-style: none; padding: 0; }
        #keys-list li { background: white; margin-bottom: 8px; border-radius: 6px; box-shadow: 0 2px 5px var(--shadow-color); }
        #keys-list a { display: block; padding: 15px; text-decoration: none; color: var(--heading-color); font-weight: 600; transition: background-color 0.2s; border-radius: 6px; }
        #keys-list a:hover { background-color: #f7f3ed; }

        /* Daily Journal View */
        .daily-view { max-width: 1000px; margin: 0 auto; }
        .daily-header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 16px; margin-bottom: 20px; }
        .daily-subtitle { margin: 6px 0 0; color: #555; }
        .daily-filter { display: flex; align-items: center; gap: 10px; font-weight: 600; }
        .daily-filter select { padding: 8px 10px; border-radius: 6px; border: 1px solid var(--border-color); background: white; }
        .daily-month-group { margin-bottom: 28px; }
        .daily-month-header { display: flex; justify-content: space-between; align-items: baseline; gap: 12px; margin-bottom: 10px; }
        .daily-month-title { font-size: 1.4rem; margin: 0; color: var(--accent-color); }
        .day-card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 14px; }
        .day-card { background: white; border: 1px solid var(--border-color); border-radius: 10px; padding: 14px; box-shadow: 0 4px 10px var(--shadow-color); cursor: pointer; transition: transform 0.1s ease, box-shadow 0.2s ease; }
        .day-card:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.08); }
        .day-card-date { font-weight: 700; color: var(--heading-color); }
        .day-card-weekday { color: #777; font-size: 0.9rem; margin-bottom: 6px; }
        .day-card-total { font-weight: 700; color: var(--accent-color); margin-top: 6px; }
        .day-card-exercises { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 4px; }
        .day-card-pill { background: #f7f3ed; border-radius: 6px; padding: 4px 8px; font-size: 0.9rem; color: var(--heading-color); border: 1px solid var(--border-color); }
        .day-detail { margin-top: 24px; background: white; border: 1px solid var(--border-color); border-radius: 10px; box-shadow: 0 4px 12px var(--shadow-color); padding: 18px; }
        .day-detail-header { display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap; }
        .day-exercise-block { border-top: 1px solid var(--border-color); padding-top: 12px; margin-top: 12px; }
        .day-exercise-title { display: flex; justify-content: space-between; align-items: center; font-weight: 700; color: var(--heading-color); }
        .day-entry { margin: 8px 0; padding: 10px; background: var(--primary-bg); border-radius: 6px; border: 1px solid var(--border-color); }
        .day-entry time { display: block; font-size: 0.85rem; color: #777; margin-bottom: 4px; }
        .muted { color: #777; }

        /* Exercise View Styles */
        .exercise-header { display: flex; justify-content: space-between; align-items: center; gap: 16px; }
        .exercise-view h1 { margin-top: 0; font-size: 2.2rem; }
        .key-toggle { display: inline-flex; align-items: center; gap: 8px; cursor: pointer; font-weight: 600; color: var(--heading-color); user-select: none; }
        .key-toggle input { width: 20px; height: 20px; accent-color: var(--key-color); cursor: pointer; }
        .key-toggle span { font-size: 0.95rem; }
        .key-toggle.checked span { color: var(--key-color); }


        .exercise-scripture { font-family: 'Lora', serif; font-style: italic; font-size: 1.1rem; padding: 15px; background-color: #f7f3ed; border-left: 4px solid var(--accent-color); border-radius: 4px; margin: 20px 0; }
        .exercise-scripture strong { font-weight: 600; color: var(--heading-color); }
        
        #entry-history-list { margin-top: 30px; border-top: 1px solid var(--border-color); padding-top: 20px; }
        .historical-entry { background-color: white; border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px var(--shadow-color); }
        .entry-meta { font-size: 0.9rem; font-weight: 600; color: var(--accent-color); margin-bottom: 10px; }
        .entry-text { white-space: pre-wrap; /* Preserves line breaks */ }

        .new-entry-area label { display: block; font-family: 'Lora', serif; font-weight: 600; font-size: 1.2rem; margin-bottom: 10px; margin-top: 30px; }
        .journal-textarea { width: 100%; min-height: 150px; border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; font-family: 'Source Sans 3', sans-serif; font-size: 1rem; line-height: 1.7; resize: vertical; box-shadow: inset 0 1px 4px var(--shadow-color); }
        .journal-textarea:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(138, 109, 70, 0.2); }
        .save-button { display: inline-block; background-color: var(--accent-color); color: white; padding: 12px 25px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s, transform 0.1s; margin-top: 20px; }
        .save-button:hover { background-color: #6d5635; }
        .save-button:active { transform: scale(0.98); }
        #save-feedback { display: inline-block; margin-left: 15px; color: green; font-weight: bold; opacity: 0; transition: opacity 0.5s; }

        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 900px; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; }
        .modal-close { font-size: 2rem; font-weight: bold; cursor: pointer; border: none; background: none; }
        .modal-body { overflow-y: auto; }
        .modal-filters { display: flex; gap: 20px; margin-bottom: 20px; align-items: center; }
        .modal-filters label { font-weight: 600; }
        .modal-filters input { padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; }
        .history-table { width: 100%; border-collapse: collapse; }
        .history-table th, .history-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .history-table th { cursor: pointer; position: relative; }
        .history-table th:hover { background-color: #f7f3ed; }
        .history-table th .sort-indicator { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); }
        .faq-item { margin-bottom: 20px; }
        .faq-item h4 { margin-bottom: 5px; color: var(--accent-color); }
        #import-choice-modal .modal-body { text-align: center; }
        #import-choice-modal button { margin: 10px; }

        /* Mobile Responsiveness */
        .mobile-menu-toggle { display: none; position: fixed; top: 15px; left: 15px; z-index: 1001; background-color: var(--accent-color); color: white; border: none; border-radius: 50%; width: 56px; height: 56px; cursor: pointer; box-shadow: 0 2px 10px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; }
        .mobile-menu-toggle svg { width: 24px; height: 24px; stroke: currentColor; stroke-width: 2.5; }
        .mobile-menu-toggle svg line { stroke-linecap: round; }

        @media (min-width: 769px) {
            .mobile-menu-toggle { display: none !important; }
        }
        @media (max-width: 768px) {
            .app-container { flex-direction: column; }
            .mobile-menu-toggle { display: block; top: auto; left: auto; right: 20px; bottom: 20px; }
            .sidebar { position: fixed; top: 0; left: 0; bottom: 0; width: 280px; z-index: 1000; transform: translateX(-100%); box-shadow: 5px 0 15px rgba(0,0,0,0.1); }
            .sidebar.open { transform: translateX(0); }
            .main-content { padding: 20px; padding-top: 40px; padding-bottom: 120px; }
            .exercise-header { flex-direction: column; align-items: stretch; }
            .key-toggle { display: flex; justify-content: space-between; margin-top: 15px; }
            .exercise-view h1 { font-size: 1.8rem; }
            .modal-filters { flex-direction: column; align-items: stretch; }
        }

    </style>
</head>
<body>

    <div class="app-container">
        <button class="mobile-menu-toggle" id="mobile-menu-toggle" aria-label="Toggle navigation">
            <svg viewBox="0 0 24 24" aria-hidden="true">
                <line x1="4" y1="7" x2="20" y2="7"></line>
                <line x1="4" y1="12" x2="20" y2="12"></line>
                <line x1="4" y1="17" x2="20" y2="17"></line>
            </svg>
        </button>

        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>The Believer's Walk</h2>
                <p>A Journal of Spiritual Exercises</p>
            </div>
            
            <div class="data-management-buttons">
                <button id="home-button" class="io-button">Home</button>
                <button id="keys-button" class="io-button">Key Exercises</button>
                <button id="daily-button" class="io-button">Daily Journal</button>
                <button id="export-button" class="io-button">Export</button>
                <button id="import-button" class="io-button">Import</button>
                <button id="history-button" class="io-button" style="flex-basis: 95%;">View History</button>
                <button id="help-button" title="Help">&#9432;</button>
                <input type="file" id="import-file-input" style="display: none;" accept=".json">
            </div>

            <h3 style="text-align: center; color: var(--heading-color);">Spiritual Exercises</h3>
            <nav id="navigation-menu"></nav>
        </aside>

        <main class="main-content" id="main-content">
            <div class="welcome-view" id="welcome-view">
                <h1 id="welcome-header">Welcome, <span id="animated-text-wrapper"><span id="animated-text"></span></span><span class="cursor"></span></h1>
                <div id="name-prompt" style="display: none;">
                    <p>Enter your name:</p>
                    <input type="text" id="name-input" placeholder="e.g., Jim, Jane, Ambassador for Christ">
                    <button id="name-submit" class="save-button">Begin</button>
                </div>
                <p id="welcome-message" style="display: none;">Tap a spiritual exercise to start journaling, or check the box to favorite it as a key focus area.</p>
            </div>

            <div class="keys-view" id="keys-view" style="display: none;">
                <h1>Key Exercises</h1>
                <div id="keys-section">
                    <p class="keys-description">Use the checkbox labelled "Mark as Key Exercise" on any exercise to favorite it. Your checked favorites appear here for quick access.</p>
                    <ul id="keys-list"></ul>
                </div>
            </div>

            <div class="daily-view" id="daily-view" style="display: none;">
                <div class="daily-header">
                    <div>
                        <h1>Daily Journal</h1>
                        <p class="daily-subtitle">Review your entries by day. Click a card to open the exercises you logged.</p>
                    </div>
                    <div class="daily-filter">
                        <label for="daily-month-select">Jump to month</label>
                        <select id="daily-month-select">
                            <option value="">All months</option>
                        </select>
                    </div>
                </div>
                <div id="daily-months"></div>
                <div class="day-detail" id="day-detail" style="display: none;">
                    <div class="day-detail-header">
                        <h2 id="day-detail-title"></h2>
                        <button class="io-button" id="day-detail-close">Close</button>
                    </div>
                    <div id="day-detail-body"></div>
                </div>
            </div>

            <div class="exercise-view" id="exercise-view" style="display: none;">
                <div class="exercise-header">
                    <h1 id="exercise-title"></h1>
                    <label class="key-toggle" id="key-toggle" for="key-checkbox" title="Mark as a Key Exercise">
                        <span id="key-checkbox-label">Mark as Key Exercise</span>
                        <input type="checkbox" id="key-checkbox">
                    </label>
                </div>
                <div class="exercise-scripture">
                    <p id="exercise-explanation"></p>
                    <strong id="exercise-reference"></strong>
                </div>

                <div id="entry-history-list">
                    <!-- Historical entries will be populated here -->
                </div>

                <div class="new-entry-area">
                    <label for="journal-entry">Add a New Entry</label>
                    <textarea id="journal-entry" class="journal-textarea" placeholder="My thoughts, confessions, praise and prayers"></textarea>
                    <button class="save-button" id="save-button">Add Entry</button>
                    <span id="save-feedback">Entry Added!</span>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="history-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Journal History</h2>
                <button class="modal-close" id="history-modal-close-button">&times;</button>
            </div>
            <div class="modal-filters">
                <div>
                    <label for="start-date">From:</label>
                    <input type="date" id="start-date">
                </div>
                <div>
                    <label for="end-date">To:</label>
                    <input type="date" id="end-date">
                </div>
                <button id="filter-button" class="io-button">Apply Filter</button>
            </div>
            <div class="modal-body">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th data-sort="date">Date <span class="sort-indicator"></span></th>
                            <th data-sort="category">Category <span class="sort-indicator"></span></th>
                            <th data-sort="exercise">Exercise <span class="sort-indicator"></span></th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="help-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>How to Use This Journal</h2>
                <button class="modal-close" id="help-modal-close-button">&times;</button>
            </div>
            <div class="modal-body">
                <div class="faq-item" style="background-color: var(--primary-bg); padding: 15px; border-radius: 8px;">
                    <h4>A Note on Your Privacy & How This App Works</h4>
                    <p>This journal was built with your privacy as the highest priority. In a world of accounts, clouds, and constant data collection, this app is fundamentally different.</p>
                    <ul style="text-align: left;">
                        <li><strong>Completely Private:</strong> Your journal entries <strong>never travel over the internet</strong> and are not stored on any company's server. Everything you write is saved directly and only on your own device's browser.</li>
                        <li><strong>No Account Needed:</strong> You will never be asked to create an account, sign up, or provide an email address. Your journal is yours alone.</li>
                        <li><strong>You Own Your Data:</strong> Your journal is automatically saved within your browser on your device. The <strong>"Export"</strong> feature lets you create a separate, <strong>permanent backup file</strong> of your journal from that data. This file can be moved to another device or saved for safekeeping. It's wise to keep this backup file in a secure location, just as you would any other important personal document. A good practice is to email the file to yourself, as services like Gmail provide excellent security.</li>
                        <li><strong>No Installation:</strong> This is a self-contained web application. There is nothing to download from an app store, ensuring it's always available.</li>
                    </ul>
                </div>
                <div class="faq-item">
                    <h4>Personalizing Your Journal</h4>
                    <p>The first time you visit, you'll be asked for your name. This is saved on your device to personalize your welcome message. It is also saved in your export file.</p>
                </div>
                <div class="faq-item">
                    <h4>Navigating Exercises</h4>
                    <p>Use the accordion menu on the left to browse exercises by category. Click on a category to expand it, then click on an exercise to view its details.</p>
                </div>
                 <div class="faq-item">
                    <h4>Adding a Journal Entry</h4>
                    <p>On any exercise page, type your reflections in the "Add a New Entry" text box and click the "Add Entry" button. Your entry will be saved with the current date and time and will appear above the text box. You can add multiple entries for each exercise.</p>
                </div>
                <div class="faq-item">
                    <h4>Marking Key Exercises</h4>
                    <p>Check the box labeled "Mark as Key Exercise" at the top of any exercise to favorite it for focus. Use the "Key Exercises" button in the sidebar to jump back to everything you've checked.</p>
                </div>
                <div class="faq-item">
                    <h4>Viewing Your History</h4>
                    <p>Click the "View History" button to see a complete list of all your journal entries. You can filter this list by date and sort it by date, category, or exercise title. In the history table, you can click on a date to go to the card for that date, click on a category to list all the entries for that category by exercise and by date, or click on an exercise to list all the entries for that exercise by date.</p>
                </div>
                 <div class="faq-item">
                    <h4>Merge vs. Replace</h4>
                    <p>When you import a file, you will be given two options. <strong>Merge</strong> will intelligently combine the journal entries and key exercises from your imported file with the data already in your browser. <strong>Replace</strong> will completely erase your current journal and replace it with the data from the imported file.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="import-choice-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Import Option</h2>
            </div>
            <div class="modal-body">
                <p>Would you like to merge the imported journal with your existing one, or replace it completely?</p>
                <button id="merge-button" class="save-button">Merge</button>
                <button id="replace-button" class="io-button">Replace</button>
            </div>
        </div>
    </div>

    <script>
    // --- DATA: The 100 Spiritual Exercises ---
    const spiritualExercises = [
        { id: 1, category: 'Prayer & Supplication', title: 'The Morning Watch', explanation: 'Begin your day with prayer and dedication to God.', reference: 'Psalm 5:3' },
        { id: 2, category: 'Prayer & Supplication', title: 'Evening Prayer', explanation: 'End your day with thanks, committing it to God.', reference: 'Psalm 4:8' },
        { id: 3, category: 'Prayer & Supplication', title: 'The Model Prayer', explanation: 'Pray the prayer Jesus taught His disciples as guide.', reference: 'Matthew 6:9-13' },
        { id: 4, category: 'Prayer & Supplication', title: 'Praying in Secret', explanation: 'Find a private place to commune alone with God.', reference: 'Matthew 6:6' },
        { id: 5, category: 'Prayer & Supplication', title: 'Intercessory Prayer', explanation: 'Pray specifically for the needs and salvation of others.', reference: '1 Timothy 2:1' },
        { id: 6, category: 'Prayer & Supplication', title: 'Prayer of Thanksgiving', explanation: 'Offer prayers focused entirely on gratitude for God\'s blessings.', reference: 'Philippians 4:6' },
        { id: 7, category: 'Prayer & Supplication', title: 'A Prayer of Confession', explanation: 'Humbly confess your specific sins to God for forgiveness.', reference: '1 John 1:9' },
        { id: 8, category: 'Prayer & Supplication', title: 'Praying Scripture', explanation: 'Pray the words of a Psalm or another passage back to God.', reference: '2 Samuel 7:27' },
        { id: 9, category: 'Prayer & Supplication', title: 'Prayer Walking', explanation: 'Walk through your community while praying for its people.', reference: '2 Chronicles 7:14' },
        { id: 10, category: 'Prayer & Supplication', title: 'Ceaseless Prayer', explanation: 'Maintain a constant attitude of prayer throughout your day.', reference: '1 Thessalonians 5:17' },
        { id: 11, category: 'Prayer & Supplication', title: 'Pray for Enemies', explanation: 'Ask God to bless and save those who persecute you.', reference: 'Matthew 5:44' },
        { id: 12, category: 'Prayer & Supplication', 'title': 'Prayer Journaling', 'explanation': 'Write down your prayers and God\'s answers to remember faithfulness.', 'reference': 'Habakkuk 2:2' },
        { id: 13, category: 'Prayer & Supplication', title: 'Family Altar', explanation: 'Lead your family in a dedicated time of prayer.', reference: 'Genesis 35:2-3' },
        { id: 14, category: 'Prayer & Supplication', title: 'Fasting & Prayer', explanation: 'Abstain from food for a time to focus on God.', reference: 'Matthew 17:21' },
        { id: 15, category: 'Prayer & Supplication', title: 'Praying for Labourers', explanation: 'Ask God to send more workers into His harvest.', reference: 'Matthew 9:38' },
        { id: 16, category: 'Study of God\'s Word', title: 'Daily Bread', explanation: 'Read a portion of the Scriptures every single day.', reference: 'Matthew 4:4' },
        { id: 17, category: 'Study of God\'s Word', title: 'Hiding the Word', explanation: 'Commit verses of Scripture to memory for spiritual strength.', reference: 'Psalm 119:11' },
        { id: 18, category: 'Study of God\'s Word', title: 'Scripture Meditation', explanation: 'Ponder deeply on a single verse or passage.', reference: 'Psalm 1:2' },
        { id: 19, category: 'Study of God\'s Word', title: 'Book Study', explanation: 'Read and study an entire book of the Bible.', reference: 'Nehemiah 8:8' },
        { id: 20, category: 'Study of God\'s Word', title: 'Topical Study', explanation: 'Study what the whole Bible says about one subject.', reference: 'Acts 17:11' },
        { id: 21, category: 'Study of God\'s Word', title: 'Character Study', explanation: 'Study the life of a single person in the Bible.', reference: '1 Corinthians 10:11' },
        { id: 22, category: 'Study of God\'s Word', title: 'Read Proverbs Daily', explanation: 'Read the chapter of Proverbs that corresponds to the day.', reference: 'Proverbs 1:5' },
        { id: 23, category: 'Study of God\'s Word', title: 'Listening to the Word', explanation: 'Listen to an audio recording of the Holy Scriptures.', reference: 'Romans 10:17' },
        { id: 24, category: 'Study of God\'s Word', title: 'Public Reading', explanation: 'Read the Bible aloud to your family or another.', reference: '1 Timothy 4:13' },
        { id: 25, category: 'Study of God\'s Word', title: 'Teaching a Child', explanation: 'Teach a Bible story or verse to a child.', reference: 'Deuteronomy 6:7' },
        { id: 26, category: 'Study of God\'s Word', title: 'A Concordance Search', explanation: 'Use a concordance to trace a word through Scripture.', reference: '2 Timothy 2:15' },
        { id: 27, category: 'Study of God\'s Word', title: 'Compare Scripture', explanation: 'Compare verses to let Scripture interpret Scripture.', reference: '1 Corinthians 2:13' },
        { id: 28, category: 'Study of God\'s Word', title: 'Bible Outlining', explanation: 'Outline a chapter or book to see its structure.', reference: 'Luke 1:3' },
        { id: 29, category: 'Study of God\'s Word', title: 'Handwriting Scripture', explanation: 'Write out a chapter of the Bible by hand.', reference: 'Deuteronomy 17:18' },
        { id: 30, category: 'Study of God\'s Word', title: 'Heeding the Word', explanation: 'Make a specific plan to obey what you have read.', reference: 'James 1:22' },
        { id: 31, category: 'Worship & Adoration', title: 'Singing Hymns', explanation: 'Sing hymns of the faith, alone or with others.', reference: 'Colossians 3:16' },
        { id: 32, category: 'Worship & Adoration', title: 'Making a Joyful Noise', explanation: 'Praise God aloud with joyful, heartfelt expression.', reference: 'Psalm 100:1' },
        { id: 33, category: 'Worship & Adoration', title: 'Listing His Attributes', explanation: 'Make a list of God\'s character traits and praise Him.', reference: 'Psalm 145:3' },
        { id: 34, category: 'Worship & Adoration', title: 'Praising His Works', explanation: 'Thank God specifically for His mighty acts and creation.', reference: 'Psalm 150:2' },
        { id: 35, category: 'Worship & Adoration', title: 'Attending Church Faithfully', explanation: 'Do not forsake the assembly of the saints.', reference: 'Hebrews 10:25' },
        { id: 36, category: 'Worship & Adoration', title: 'Remembering the Lord\'s Supper', explanation: 'Partake in the ordinance with a solemn, thankful heart.', reference: '1 Corinthians 11:24' },
        { id: 37, category: 'Worship & Adoration', title: 'Respecting God\'s House', explanation: 'Behave with reverence and sobriety in the church building.', reference: 'Habakkuk 2:20' },
        { id: 38, category: 'Worship & Adoration', title: 'A Sabbath Rest', explanation: 'Set aside the Lord\'s Day for rest and worship.', reference: 'Exodus 20:8' },
        { id: 39, category: 'Worship & Adoration', title: 'Silent Adoration', explanation: 'Sit in silence, simply adoring God for who He is.', reference: 'Psalm 46:10' },
        { id: 40, category: 'Worship & Adoration', title: 'Voicing Praise', explanation: 'Tell another person something great God has done for you.', reference: 'Psalm 34:1' },
        { id: 41, category: 'Service & Fellowship', title: 'Encouraging a Brother', explanation: 'Speak a word of encouragement to a fellow believer.', reference: '1 Thessalonians 5:11' },
        { id: 42, category: 'Service & Fellowship', title: 'Visiting the Sick', explanation: 'Visit and pray with someone who is ill.', reference: 'Matthew 25:36' },
        { id: 43, category: 'Service & Fellowship', title: 'Hospitality', explanation: 'Open your home to a fellow believer for fellowship.', reference: 'Romans 12:13' },
        { id: 44, category: 'Service & Fellowship', title: 'Bearing Burdens', explanation: 'Help carry the load of someone who is struggling.', reference: 'Galatians 6:2' },
        { id: 45, category: 'Service & Fellowship', title: 'Serving in Church', explanation: 'Volunteer for a practical need within your local church.', reference: '1 Peter 4:10' },
        { id: 46, category: 'Service & Fellowship', title: 'A Phone Call of Care', explanation: 'Call someone from church just to check on them.', reference: '1 John 3:18' },
        { id: 47, category: 'Service & Fellowship', title: 'Writing a Note', explanation: 'Write a letter of encouragement to a pastor or missionary.', reference: '2 Corinthians 1:3-4' },
        { id: 48, category: 'Service & Fellowship', title: 'Caring for Widows', explanation: 'Provide practical help or comfort to a widow.', reference: 'James 1:27' },
        { id: 49, category: 'Service & Fellowship', title: 'Giving a Cup of Water', explanation: 'Perform a simple act of kindness in Christ\'s name.', reference: 'Matthew 10:42' },
        { id: 50, category: 'Service & Fellowship', title: 'Forgiving a Debt', explanation: 'Forgive someone who has wronged you, as Christ forgave.', reference: 'Ephesians 4:32' },
        { id: 51, category: 'Service & Fellowship', title: 'Restoring a Brother', explanation: 'Gently help a brother who has fallen into sin.', reference: 'Galatians 6:1' },
        { id: 52, category: 'Service & Fellowship', title: 'Submitting to One Another', explanation: 'Humbly prefer others and yield in love.', reference: 'Ephesians 5:21' },
        { id: 53, category: 'Service & Fellowship', title: 'Praying with a Believer', explanation: 'Ask another believer to pray with you about something specific.', reference: 'James 5:16' },
        { id: 54, category: 'Service & Fellowship', title: 'Mentoring a Younger Believer', explanation: 'Disciple someone who is newer in the faith.', reference: 'Titus 2:3-4' },
        { id: 55, category: 'Service & Fellowship', title: 'Honouring the Elderly', explanation: 'Show special respect and deference to the aged saints.', reference: 'Leviticus 19:32' },
        { id: 56, category: 'Personal Holiness & Discipleship', title: 'Examining Yourself', explanation: 'Test your own faith to see if you are in Christ.', reference: '2 Corinthians 13:5' },
        { id: 57, category: 'Personal Holiness & Discipleship', title: 'Mortifying the Flesh', explanation: 'Actively put to death the sinful deeds of the body.', reference: 'Romans 8:13' },
        { id: 58, category: 'Personal Holiness & Discipleship', title: 'Guarding Your Heart', explanation: 'Be watchful over the affections and motives of your heart.', reference: 'Proverbs 4:23' },
        { id: 59, category: 'Personal Holiness & Discipleship', title: 'Guarding Your Eyes', explanation: 'Be deliberate about what you allow yourself to see.', reference: 'Job 31:1' },
        { id: 60, category: 'Personal Holiness & Discipleship', title: 'Bridling Your Tongue', explanation: 'Practice speaking with grace and restrain from evil words.', reference: 'James 1:26' },
        { id: 61, category: 'Personal Holiness & Discipleship', title: 'Shunning Gossip', explanation: 'Refuse to listen to or spread unkind reports about others.', reference: 'Proverbs 20:19' },
        { id: 62, category: 'Personal Holiness & Discipleship', title: 'Practicing Humility', explanation: 'Consider others as better than yourself in lowliness of mind.', reference: 'Philippians 2:3' },
        { id: 63, category: 'Personal Holiness & Discipleship', title: 'Cultivating Patience', explanation: 'Practice enduring difficult situations or people without complaint.', reference: 'James 1:4' },
        { id: 64, category: 'Personal Holiness & Discipleship', title: 'Pursuing Peace', explanation: 'Actively seek to live peaceably with all men.', reference: 'Romans 12:18' },
        { id: 65, category: 'Personal Holiness & Discipleship', title: 'Choosing Godly Friends', explanation: 'Seek fellowship with those who walk in wisdom.', reference: 'Proverbs 13:20' },
        { id: 66, category: 'Personal Holiness & Discipleship', title: 'Redeeming the Time', explanation: 'Use your time wisely for eternal, not worldly, purposes.', reference: 'Ephesians 5:16' },
        { id: 67, category: 'Personal Holiness & Discipleship', title: 'Thinking on Good Things', explanation: 'Purposely focus your mind on things that are pure.', reference: 'Philippians 4:8' },
        { id: 68, category: 'Personal Holiness & Discipleship', title: 'Putting on Christ', explanation: 'Consciously seek to live and act like Jesus today.', reference: 'Romans 13:14' },
        { id: 69, category: 'Personal Holiness & Discipleship', title: 'A Media Fast', explanation: 'Abstain from television or internet for a set time.', reference: 'Psalm 101:3' },
        { id: 70, category: 'Personal Holiness & Discipleship', title: 'Contentment Practice', explanation: 'Find a reason to be content in your current circumstance.', reference: 'Philippians 4:11' },
        { id: 71, 'category': 'Personal Holiness & Discipleship', title: 'Fleeing Temptation', explanation: 'Physically remove yourself from a situation of temptation.', reference: '1 Corinthians 6:18' },
        { id: 72, category: 'Personal Holiness & Discipleship', title: 'Self-Denial', explanation: 'Deny yourself a legitimate pleasure for a spiritual purpose.', reference: 'Luke 9:23' },
        { id: 73, category: 'Personal Holiness & Discipleship', title: 'Practicing Honesty', explanation: 'Be scrupulously honest in a small, unseen matter.', reference: 'Luke 16:10' },
        { id: 74, category: 'Personal Holiness & Discipleship', title: 'Keeping a Promise', explanation: 'Fulfill a promise you made, keeping your word.', reference: 'Psalm 15:4' },
        { id: 75, category: 'Personal Holiness & Discipleship', title: 'A Grumbling Fast', explanation: 'Go a full day without complaining about anything.', reference: 'Philippians 2:14' },
        { id: 76, category: 'Evangelism & Witnessing', title: 'Giving a Testimony', explanation: 'Write out your testimony of salvation to share.', reference: 'Mark 5:19' },
        { id: 77, category: 'Evangelism & Witnessing', title: 'Praying for the Lost', explanation: 'Pray by name for the salvation of specific people.', reference: 'Romans 10:1' },
        { id: 78, category: 'Evangelism & Witnessing', title: 'Gospel Tract Distribution', explanation: 'Leave a gospel tract in a public place.', reference: 'Psalm 68:11' },
        { id: 79, category: 'Evangelism & Witnessing', title: 'Being Ready with an Answer', explanation: 'Prepare to explain the hope that is in you.', reference: '1 Peter 3:15' },
        { id: 80, category: 'Evangelism & Witnessing', title: 'Answering a Question', explanation: 'Answer a spiritual question someone asks with Scripture.', reference: 'Colossians 4:6' },
        { id: 81, category: 'Evangelism & Witnessing', title: 'Inviting to Church', explanation: 'Personally invite a friend or neighbor to a church service.', reference: 'Luke 14:23' },
        { id: 82, category: 'Evangelism & Witnessing', title: 'Living a Quiet Testimony', explanation: 'Let your good works be a silent witness at work.', reference: '1 Peter 2:12' },
        { id: 83, category: 'Evangelism & Witnessing', title: 'Sharing the Gospel', explanation: 'Intentionally share the plan of salvation with someone.', reference: 'Acts 1:8' },
        { id: 84, category: 'Evangelism & Witnessing', title: 'Supporting Missions', explanation: 'Give financially to the support of a missionary.', reference: 'Philippians 4:15-17' },
        { id: 85, category: 'Evangelism & Witnessing', title: 'Writing to a Missionary', explanation: 'Write a letter to a missionary on the field.', reference: '3 John 1:8' },
        { id: 86, category: 'Trust, Stewardship & Surrender', title: 'Tithing Cheerfully', explanation: 'Give the first tenth of your increase back to God.', reference: 'Malachi 3:10' },
        { id: 87, category: 'Trust, Stewardship & Surrender', title: 'Giving an Offering', explanation: 'Give a free-will offering above the tithe joyfully.', reference: '2 Corinthians 9:7' },
        { id: 88, category: 'Trust, Stewardship & Surrender', title: 'Casting Your Cares', explanation: 'Verbally give a specific anxiety over to the Lord.', reference: '1 Peter 5:7' },
        { id: 89, category: 'Trust, Stewardship & Surrender', title: 'Trusting in a Trial', explanation: 'Acknowledge God\'s sovereignty in the midst of a difficulty.', reference: 'Job 13:15' },
        { id: 90, category: 'Trust, Stewardship & Surrender', title: 'A "Commitment to God" Act', explanation: 'Make a conscious decision to commit one area of life to God.', reference: 'Proverbs 16:3' },
        { id: 91, category: 'Trust, Stewardship & Surrender', title: 'Acknowledging God', explanation: 'Verbally acknowledge God in a decision you have to make.', reference: 'Proverbs 3:6' },
        { id: 92, category: 'Trust, Stewardship & Surrender', title: 'Waiting on the LORD', explanation: 'Purposefully wait for God\'s timing without forcing a solution.', reference: 'Isaiah 40:31' },
        { id: 93, category: 'Trust, Stewardship & Surrender', title: 'A Stewardship Review', explanation: 'Review your finances and time, asking if they honor God.', reference: '1 Corinthians 4:2' },
        { id: 94, category: 'Trust, Stewardship & Surrender', title: 'Yielding Your Rights', explanation: 'Willingly give up a personal right for another\'s sake.', reference: '1 Corinthians 9:12' },
        { id: 95, category: 'Trust, Stewardship & Surrender', title: 'Remembering God\'s Faithfulness', explanation: 'Recount specific times God has been faithful in your past.', reference: 'Lamentations 3:22-23' },
        { id: 96, category: 'Trust, Stewardship & Surrender', title: 'Resting in Providence', explanation: 'Choose to trust God\'s unseen plan for your life.', reference: 'Romans 8:28' },
        { id: 97, category: 'Trust, Stewardship & Surrender', title: 'Labouring with Diligence', explanation: 'Do your daily work heartily, as unto the Lord.', reference: 'Colossians 3:23' },
        { id: 98, category: 'Trust, Stewardship & Surrender', title: 'Using Your Talents', explanation: 'Use a God-given ability for His glory, not your own.', reference: 'Matthew 25:21' },
        { id: 99, category: 'Trust, Stewardship & Surrender', title: 'Seeking Godly Counsel', explanation: 'Ask a wise, older believer for advice on a matter.', reference: 'Proverbs 11:14' },
        { id: 100, category: 'Trust, Stewardship & Surrender', title: 'A Final Surrender', explanation: 'End the day by saying, "Thy will be done."', reference: 'Luke 22:42' }
    ];

    // --- APPLICATION LOGIC ---
    document.addEventListener('DOMContentLoaded', () => {
        // Get references to all the important elements on the page
        const getEl = (id) => document.getElementById(id);
        const navigationMenu = getEl('navigation-menu');
        const welcomeView = getEl('welcome-view');
        const welcomeHeader = getEl('welcome-header');
        const animatedTextWrapper = getEl('animated-text-wrapper');
        const animatedText = getEl('animated-text');
        const namePrompt = getEl('name-prompt');
        const nameInput = getEl('name-input');
        const nameSubmit = getEl('name-submit');
        const welcomeMessage = getEl('welcome-message');
        const keysView = getEl('keys-view');
        const keysList = getEl('keys-list');
        const dailyView = getEl('daily-view');
        const dailyMonths = getEl('daily-months');
        const dailyMonthSelect = getEl('daily-month-select');
        const dayDetail = getEl('day-detail');
        const dayDetailTitle = getEl('day-detail-title');
        const dayDetailBody = getEl('day-detail-body');
        const dayDetailClose = getEl('day-detail-close');
        const exerciseView = getEl('exercise-view');
        const exerciseTitle = getEl('exercise-title');
        const keyToggle = getEl('key-toggle');
        const keyCheckbox = getEl('key-checkbox');
        const keyCheckboxLabel = getEl('key-checkbox-label');
        const exerciseExplanation = getEl('exercise-explanation');
        const exerciseReference = getEl('exercise-reference');
        const entryHistoryList = getEl('entry-history-list');
        const journalEntry = getEl('journal-entry');
        const saveButton = getEl('save-button');
        const saveFeedback = getEl('save-feedback');
        const mobileMenuToggle = getEl('mobile-menu-toggle');
        const sidebar = getEl('sidebar');
        const mainContent = getEl('main-content');
        const homeButton = getEl('home-button');
        const keysButton = getEl('keys-button');
        const dailyButton = getEl('daily-button');
        const exportButton = getEl('export-button');
        const importButton = getEl('import-button');
        const importFileInput = getEl('import-file-input');
        const historyButton = getEl('history-button');
        const helpButton = getEl('help-button');
        const historyModal = getEl('history-modal');
        const helpModal = getEl('help-modal');
        const importChoiceModal = getEl('import-choice-modal');
        const historyModalCloseButton = getEl('history-modal-close-button');
        const helpModalCloseButton = getEl('help-modal-close-button');
        const mergeButton = getEl('merge-button');
        const replaceButton = getEl('replace-button');
        const historyTableBody = getEl('history-table-body');
        const startDateInput = getEl('start-date');
        const endDateInput = getEl('end-date');
        const filterButton = getEl('filter-button');

        let currentExerciseId = null;
        let keys = [];
        let historyReportData = [];
        let currentSort = { key: 'date', order: 'desc' };
        let animationRunning = false;
        let importedData = null;
        let dailyDayIndex = {};

        // --- Data Handling ---
        const getKeys = () => JSON.parse(localStorage.getItem('journalKeys')) || [];
        const saveKeys = () => localStorage.setItem('journalKeys', JSON.stringify(keys));

        // --- Typing Animation ---
        const appellations = [
            "Christian",
            "Ambassador for Christ",
            "Disciple of the Most High God",
            "Follower of Jesus",
            "One who is more than a conqueror"
        ];
        let textIndex = 0;
        let charIndex = 0;
        let isDeleting = false;

        function typeAnimation() {
            if (!animationRunning) return;
            const currentText = appellations[textIndex];
            const typeSpeed = 80; // Consistent speed for typing and deleting

            if (isDeleting) {
                animatedText.textContent = currentText.substring(0, charIndex - 1);
                charIndex--;
            } else {
                animatedText.textContent = currentText.substring(0, charIndex + 1);
                charIndex++;
            }

            if (!isDeleting && charIndex === currentText.length) {
                setTimeout(() => {
                    isDeleting = true;
                    animatedTextWrapper.classList.add('deleting');
                }, 2000); // Pause at end
            } else if (isDeleting && charIndex === 0) {
                isDeleting = false;
                animatedTextWrapper.classList.remove('deleting');
                textIndex = (textIndex + 1) % appellations.length;
            }
            
            setTimeout(typeAnimation, typeSpeed);
        }

        function stopAnimation() {
            animationRunning = false;
            welcomeHeader.innerHTML = 'Welcome, Christian.';
        }

        // --- Name Personalization ---
        function setupWelcome() {
            const savedName = localStorage.getItem('userName');
            if (savedName) {
                welcomeHeader.innerHTML = `Welcome, ${savedName}.`;
                namePrompt.style.display = 'none';
                welcomeMessage.style.display = 'block';
            } else {
                animationRunning = true;
                typeAnimation();
                namePrompt.style.display = 'block';
            }
        }

        function saveName() {
            animationRunning = false;
            const userName = nameInput.value.trim();
            if (userName) {
                localStorage.setItem('userName', userName);
                setupWelcome();
            }
        }

        // --- Keys Logic ---
        function displayKeys() {
            keys = getKeys();
            keysList.innerHTML = '';
            if (keys.length > 0) {
                const keyedExercises = keys.map(id => spiritualExercises.find(ex => ex.id === id)).filter(Boolean);
                keyedExercises.forEach(exercise => {
                    const li = document.createElement('li');
                    const a = document.createElement('a');
                    a.href = `#exercise-${exercise.id}`;
                    a.dataset.id = exercise.id;
                    a.textContent = exercise.title;
                    li.appendChild(a);
                    keysList.appendChild(li);
                });
            } else {
                keysList.innerHTML = `<li><p>You haven't marked any Key Exercises yet. Check the box at the top of an exercise page to add it here.</p></li>`;
            }
        }

        function toggleKey(id, isChecked) {
            keys = getKeys();
            const index = keys.indexOf(id);
            if (isChecked && index === -1) {
                keys.push(id);
            } else if (!isChecked && index > -1) {
                keys.splice(index, 1);
            }
            saveKeys();
            
            // Update UI elements
            updateKeyToggle(); // For exercise view
            if (keysView.style.display === 'block') displayKeys(); // For keys view
            
            // Update the checkbox in the nav menu
            const navCheckbox = navigationMenu.querySelector(`.key-toggle-nav[data-id='${id}']`);
            if (navCheckbox) navCheckbox.checked = isChecked;
        }

        function updateKeyToggle() {
            if (currentExerciseId === null) {
                keyCheckbox.checked = false;
                keyToggle.classList.remove('checked');
                keyCheckboxLabel.textContent = 'Mark as Key Exercise';
                keyToggle.title = "Mark as a Key Exercise";
                return;
            }

            keys = getKeys();
            const isKeyed = keys.includes(currentExerciseId);
            keyCheckbox.checked = isKeyed;
            keyToggle.classList.toggle('checked', isKeyed);
            keyCheckboxLabel.textContent = isKeyed ? 'Marked as Key Exercise' : 'Mark as Key Exercise';
            keyToggle.title = isKeyed ? "Unmark as a Key Exercise" : "Mark as a Key Exercise";

            // Also update the nav menu checkbox
            const navCheckbox = navigationMenu.querySelector(`.key-toggle-nav[data-id='${currentExerciseId}']`);
            if (navCheckbox) navCheckbox.checked = isKeyed;
        }

        // --- Daily Journal Logic ---
        function buildDailyJournal() {
            dailyMonths.innerHTML = '';
            dailyMonthSelect.innerHTML = '<option value="">All months</option>';
            dayDetail.style.display = 'none';
            dailyDayIndex = {};

            const days = {};

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (!key.startsWith('journalEntry-')) continue;

                const exerciseId = parseInt(key.split('-')[1], 10);
                const exercise = spiritualExercises.find(ex => ex.id === exerciseId);
                if (!exercise) continue;

                const entries = JSON.parse(localStorage.getItem(key)) || [];
                entries.forEach(entry => {
                    if (!entry.text) return;
                    const when = new Date(entry.timestamp);
                    const dateKey = when.toISOString().split('T')[0];

                    if (!days[dateKey]) days[dateKey] = { date: new Date(dateKey), entries: [] };
                    days[dateKey].entries.push({
                        exerciseId,
                        title: exercise.title,
                        category: exercise.category,
                        text: entry.text,
                        timestamp: entry.timestamp
                    });
                });
            }

            const dayKeys = Object.keys(days).sort((a, b) => new Date(b) - new Date(a));
            if (dayKeys.length === 0) {
                dailyMonths.innerHTML = '<p class="muted">No journal entries yet. Add an entry to see it here.</p>';
                return;
            }

            const months = {};
            dayKeys.forEach(dateKey => {
                const monthKey = dateKey.slice(0, 7); // YYYY-MM
                if (!months[monthKey]) months[monthKey] = [];
                months[monthKey].push(days[dateKey]);
                dailyDayIndex[dateKey] = days[dateKey];
            });

            Object.keys(months).sort((a, b) => b.localeCompare(a)).forEach(monthKey => {
                const monthLabel = new Date(`${monthKey}-01T00:00:00`).toLocaleDateString(undefined, { month: 'long', year: 'numeric' });
                const opt = document.createElement('option');
                opt.value = monthKey;
                opt.textContent = monthLabel;
                dailyMonthSelect.appendChild(opt);

                const monthGroup = document.createElement('section');
                monthGroup.className = 'daily-month-group';
                monthGroup.dataset.monthGroup = monthKey;

                const header = document.createElement('div');
                header.className = 'daily-month-header';
                header.innerHTML = `<h3 class="daily-month-title">${monthLabel}</h3><span class="muted">${months[monthKey].length} day${months[monthKey].length === 1 ? '' : 's'} logged</span>`;
                monthGroup.appendChild(header);

                const grid = document.createElement('div');
                grid.className = 'day-card-grid';

                months[monthKey].forEach(day => {
                    const uniqueExercises = [...new Set(day.entries.map(e => e.title))];
                    const dateKey = day.date.toISOString().split('T')[0];
                    const card = document.createElement('article');
                    card.className = 'day-card';
                    card.dataset.date = dateKey;
                    card.innerHTML = `
                        <div class="day-card-date">${day.date.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' })}</div>
                        <div class="day-card-weekday">${day.date.toLocaleDateString(undefined, { weekday: 'long' })}</div>
                        <div class="day-card-total">${day.entries.length} entr${day.entries.length === 1 ? 'y' : 'ies'}</div>
                        <div class="day-card-exercises">${uniqueExercises.map(name => `<span class="day-card-pill">${name}</span>`).join('')}</div>
                    `;
                    grid.appendChild(card);
                });

                monthGroup.appendChild(grid);
                dailyMonths.appendChild(monthGroup);
            });
        }

        function showDayDetail(dateKey) {
            const day = dailyDayIndex[dateKey];
            if (!day) return;

            dayDetailTitle.textContent = day.date.toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
            dayDetailBody.innerHTML = '';

            const grouped = {};
            day.entries.forEach(entry => {
                if (!grouped[entry.exerciseId]) grouped[entry.exerciseId] = { title: entry.title, category: entry.category, entries: [] };
                grouped[entry.exerciseId].entries.push(entry);
            });

            Object.values(grouped).forEach(group => {
                const block = document.createElement('section');
                block.className = 'day-exercise-block';
                block.innerHTML = `
                    <div class="day-exercise-title">
                        <span>${group.title}</span>
                        <span class="muted">${group.category}</span>
                    </div>
                `;
                group.entries.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp)).forEach(entry => {
                    const entryDiv = document.createElement('div');
                    entryDiv.className = 'day-entry';
                    entryDiv.innerHTML = `
                        <time>${new Date(entry.timestamp).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' })}</time>
                        <div>${entry.text}</div>
                    `;
                    block.appendChild(entryDiv);
                });
                dayDetailBody.appendChild(block);
            });

            dayDetail.style.display = 'block';
        }

        function showDailyScreen() {
            currentExerciseId = null;
            exerciseView.style.display = 'none';
            keysView.style.display = 'none';
            welcomeView.style.display = 'none';
            dayDetail.style.display = 'none';
            dailyView.style.display = 'block';
            document.querySelectorAll('.exercise-list-item a').forEach(a => a.classList.remove('active'));
            buildDailyJournal();
            if (window.innerWidth <= 768) sidebar.classList.remove('open');
        }

        // --- Navigation & Display ---
        function populateNavMenu() {
            const categories = {};
            spiritualExercises.forEach(ex => {
                if (!categories[ex.category]) categories[ex.category] = [];
                categories[ex.category].push(ex);
            });

            navigationMenu.innerHTML = '';
            keys = getKeys(); 

            for (const category in categories) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category-list';
                const categoryTitle = document.createElement('h3');
                categoryTitle.textContent = category;
                categoryDiv.appendChild(categoryTitle);
                const exerciseList = document.createElement('ul');
                exerciseList.className = 'exercise-list';
                categories[category].forEach(ex => {
                    const listItem = document.createElement('li');
                    listItem.className = 'exercise-list-item';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'key-toggle-nav';
                    checkbox.dataset.id = ex.id;
                    checkbox.checked = keys.includes(ex.id);
                    
                    const link = document.createElement('a');
                    link.href = `#exercise-${ex.id}`;
                    link.textContent = `${ex.id}. ${ex.title}`;
                    link.dataset.id = ex.id;

                    listItem.appendChild(checkbox);
                    listItem.appendChild(link);
                    exerciseList.appendChild(listItem);
                });
                categoryDiv.appendChild(exerciseList);
                navigationMenu.appendChild(categoryDiv);
            }
        }

        function showWelcomeScreen() {
            currentExerciseId = null;
            exerciseView.style.display = 'none';
            keysView.style.display = 'none';
            dailyView.style.display = 'none';
            welcomeView.style.display = 'block';
            document.querySelectorAll('.exercise-list-item a').forEach(a => a.classList.remove('active'));
            setupWelcome();
            if (window.innerWidth <= 768) sidebar.classList.remove('open');
        }

        function showKeysScreen() {
            currentExerciseId = null;
            exerciseView.style.display = 'none';
            welcomeView.style.display = 'none';
            dailyView.style.display = 'none';
            keysView.style.display = 'block';
            document.querySelectorAll('.exercise-list-item a').forEach(a => a.classList.remove('active'));
            displayKeys();
            if (window.innerWidth <= 768) sidebar.classList.remove('open');
        }

        function renderEntryHistory(exerciseId) {
            const entriesJSON = localStorage.getItem(`journalEntry-${exerciseId}`);
            const entries = entriesJSON ? JSON.parse(entriesJSON) : [];
            entryHistoryList.innerHTML = '';
            // Display newest entries first
            entries.slice().reverse().forEach(entry => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'historical-entry';
                
                const metaDiv = document.createElement('div');
                metaDiv.className = 'entry-meta';
                metaDiv.textContent = new Date(entry.timestamp).toLocaleString();
                
                const textDiv = document.createElement('div');
                textDiv.className = 'entry-text';
                textDiv.textContent = entry.text;

                entryDiv.appendChild(metaDiv);
                entryDiv.appendChild(textDiv);
                entryHistoryList.appendChild(entryDiv);
            });
        }

        function showExercise(id) {
            currentExerciseId = parseInt(id);
            const exercise = spiritualExercises.find(ex => ex.id === currentExerciseId);

            if (exercise) {
                exerciseTitle.textContent = `${exercise.id}. ${exercise.title}`;
                exerciseExplanation.textContent = exercise.explanation;
                exerciseReference.textContent = exercise.reference;
                
                renderEntryHistory(currentExerciseId);
                journalEntry.value = ''; // Clear textarea for new entry

                updateKeyToggle();
                welcomeView.style.display = 'none';
                keysView.style.display = 'none';
                dailyView.style.display = 'none';
                exerciseView.style.display = 'block';

                document.querySelectorAll('.exercise-list-item a').forEach(a => a.classList.remove('active'));
                const activeLink = document.querySelector(`.exercise-list-item a[data-id='${currentExerciseId}']`);
                if (activeLink) {
                    activeLink.classList.add('active');
                    activeLink.closest('.category-list').classList.add('open');
                }
                
                if (window.innerWidth <= 768) sidebar.classList.remove('open');
            }
        }

        // --- Save Entry Logic (with Timestamp) ---
        function saveEntry() {
            if (currentExerciseId !== null && journalEntry.value.trim() !== '') {
                const entriesJSON = localStorage.getItem(`journalEntry-${currentExerciseId}`);
                const entries = entriesJSON ? JSON.parse(entriesJSON) : [];
                
                const newEntry = {
                    text: journalEntry.value.trim(),
                    timestamp: new Date().toISOString()
                };
                entries.push(newEntry);
                
                localStorage.setItem(`journalEntry-${currentExerciseId}`, JSON.stringify(entries));
                
                renderEntryHistory(currentExerciseId); // Re-render the history list
                journalEntry.value = ''; // Clear the textarea
                
                saveFeedback.style.opacity = 1;
                setTimeout(() => { saveFeedback.style.opacity = 0; }, 2000);
            }
        }

        // --- History Modal Logic ---
        function generateHistoryReport() {
            historyReportData = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('journalEntry-')) {
                    const exerciseId = parseInt(key.split('-')[1]);
                    const exercise = spiritualExercises.find(ex => ex.id === exerciseId);
                    const entries = JSON.parse(localStorage.getItem(key));

                    if (exercise && Array.isArray(entries)) {
                        entries.forEach(entry => {
                             if(entry.text) {
                                historyReportData.push({
                                    date: new Date(entry.timestamp),
                                    category: exercise.category,
                                    exercise: exercise.title,
                                    text: entry.text
                                });
                            }
                        });
                    }
                }
            }
        }

        function renderHistoryTable(data) {
            historyTableBody.innerHTML = '';
            if (data.length === 0) {
                historyTableBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">No entries found for the selected period.</td></tr>';
                return;
            }
            data.forEach(item => {
                const row = document.createElement('tr');
                const dateKey = item.date.toISOString().split('T')[0];
                row.innerHTML = `
                    <td data-date="${dateKey}" style="cursor: pointer;">${item.date.toLocaleDateString()}</td>
                    <td data-category="${item.category}" style="cursor: pointer;">${item.category}</td>
                    <td data-exercise="${item.exercise}" style="cursor: pointer;">${item.exercise}</td>
                `;
                historyTableBody.appendChild(row);
            });
        }
        
        function sortHistory(key) {
            const order = (currentSort.key === key && currentSort.order === 'asc') ? 'desc' : 'asc';
            currentSort = { key, order };
            
            historyReportData.sort((a, b) => {
                let valA = a[key];
                let valB = b[key];
                if (key === 'date') {
                    valA = valA.getTime();
                    valB = valB.getTime();
                } else { // For category and exercise, add secondary sort by date
                    if (valA < valB) return order === 'asc' ? -1 : 1;
                    if (valA > valB) return order === 'asc' ? 1 : -1;
                    // If primary keys are equal, sort by date descending
                    return b.date.getTime() - a.date.getTime();
                }
                if (valA < valB) return order === 'asc' ? -1 : 1;
                if (valA > valB) return order === 'asc' ? 1 : -1;
                return 0;
            });
            
            document.querySelectorAll('.history-table th .sort-indicator').forEach(ind => ind.textContent = '');
            const indicator = document.querySelector(`.history-table th[data-sort="${key}"] .sort-indicator`);
            indicator.textContent = order === 'asc' ? 'â–²' : 'â–¼';
            
            renderHistoryTable(historyReportData);
        }
        
        function filterHistory() {
            generateHistoryReport();
            let filteredData = historyReportData;
            const startDate = startDateInput.valueAsDate;
            const endDate = endDateInput.valueAsDate;

            if (startDate) {
                filteredData = filteredData.filter(item => item.date >= startDate);
            }
            if (endDate) {
                const inclusiveEndDate = new Date(endDate);
                inclusiveEndDate.setDate(inclusiveEndDate.getDate() + 1);
                filteredData = filteredData.filter(item => item.date < inclusiveEndDate);
            }
            
            historyReportData = filteredData;
            sortHistory(currentSort.key);
        }

        // --- Export and Import Logic ---
        function exportJournal() {
            const dataToExport = {
                userName: localStorage.getItem('userName') || '',
                journalKeys: getKeys(),
                journalEntries: {}
            };
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('journalEntry-')) {
                    dataToExport.journalEntries[key] = localStorage.getItem(key);
                }
            }
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `spiritual_journal_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    importedData = JSON.parse(e.target.result);
                    if (importedData && (importedData.journalEntries || importedData.userName || importedData.journalKeys)) {
                        importChoiceModal.style.display = 'flex';
                    } else {
                        alert('Error: Invalid journal file format.');
                    }
                } catch (error) {
                    alert('Error reading or parsing the file.');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function replaceData(data) {
            localStorage.clear();
            if(data.userName) localStorage.setItem('userName', data.userName);
            if(data.journalKeys) localStorage.setItem('journalKeys', JSON.stringify(data.journalKeys));
            if(data.journalEntries) {
                for (const key in data.journalEntries) {
                    localStorage.setItem(key, data.journalEntries[key]);
                }
            }
            alert('Journal replaced successfully! The page will now reload.');
            location.reload();
        }

        function mergeData(data) {
            // Merge/overwrite name
            if(data.userName) localStorage.setItem('userName', data.userName);

            // Merge keys
            const localKeys = getKeys();
            const importedKeys = data.journalKeys || [];
            const mergedKeys = [...new Set([...localKeys, ...importedKeys])];
            localStorage.setItem('journalKeys', JSON.stringify(mergedKeys));

            // Merge entries
            if (data.journalEntries) {
                for (const key in data.journalEntries) {
                    const localEntries = JSON.parse(localStorage.getItem(key)) || [];
                    const importedEntries = JSON.parse(data.journalEntries[key]) || [];
                    const allEntries = [...localEntries, ...importedEntries];
                    
                    // Remove duplicates based on timestamp and text
                    const uniqueEntries = allEntries.filter((entry, index, self) =>
                        index === self.findIndex((e) => (
                            e.timestamp === entry.timestamp && e.text === entry.text
                        ))
                    );
                    
                    // Sort by date to keep them in order
                    uniqueEntries.sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));

                    localStorage.setItem(key, JSON.stringify(uniqueEntries));
                }
            }
            alert('Journal merged successfully! The page will now reload.');
            location.reload();
        }

        // --- Event Listeners ---
        nameSubmit.addEventListener('click', saveName);
        nameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') saveName(); });
        nameInput.addEventListener('focus', stopAnimation, { once: true });
        
        navigationMenu.addEventListener('click', (e) => {
            if (e.target.classList.contains('key-toggle-nav')) {
                const id = parseInt(e.target.dataset.id);
                toggleKey(id, e.target.checked);
                e.stopPropagation();
                return;
            }
            if (e.target.tagName === 'H3') e.target.parentElement.classList.toggle('open');
            if (e.target.tagName === 'A') { e.preventDefault(); showExercise(e.target.dataset.id); }
        });
        
        keysList.addEventListener('click', (e) => {
            if (e.target.tagName === 'A') { e.preventDefault(); showExercise(e.target.dataset.id); }
        });

        homeButton.addEventListener('click', showWelcomeScreen);
        keysButton.addEventListener('click', showKeysScreen);
        dailyButton.addEventListener('click', showDailyScreen);
        keyCheckbox.addEventListener('change', (e) => toggleKey(currentExerciseId, e.target.checked));
        saveButton.addEventListener('click', saveEntry);
        dailyMonths.addEventListener('click', (e) => {
            const card = e.target.closest('.day-card');
            if (card) showDayDetail(card.dataset.date);
        });
        dailyMonthSelect.addEventListener('change', () => {
            const monthId = dailyMonthSelect.value;
            if (!monthId) return;
            const section = dailyMonths.querySelector(`[data-month-group="${monthId}"]`);
            if (section) section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
        dayDetailClose.addEventListener('click', () => dayDetail.style.display = 'none');
        
        historyButton.addEventListener('click', () => {
            filterHistory();
            historyModal.style.display = 'flex';
        });
        helpButton.addEventListener('click', () => {
            helpModal.style.display = 'flex';
        });

        historyModalCloseButton.addEventListener('click', () => historyModal.style.display = 'none');
        helpModalCloseButton.addEventListener('click', () => helpModal.style.display = 'none');
        
        filterButton.addEventListener('click', filterHistory);
        document.querySelectorAll('.history-table th').forEach(th => th.addEventListener('click', () => sortHistory(th.dataset.sort)));
        historyTableBody.addEventListener('click', (e) => {
            const target = e.target;
            if (target.tagName !== 'TD') return;

            const date = target.dataset.date;
            const category = target.dataset.category;
            const exercise = target.dataset.exercise;

            if (date && target.cellIndex === 0) { // Clicked on Date
                historyModal.style.display = 'none';
                showDailyScreen();
                // Use requestAnimationFrame to ensure the daily view is rendered
                requestAnimationFrame(() => {
                    const card = dailyMonths.querySelector(`.day-card[data-date="${date}"]`);
                    if (card) {
                        card.click();
                        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                });
            } else if (category && target.cellIndex === 1) { // Clicked on Category
                const categoryData = historyReportData.filter(item => item.category === category);
                renderHistoryTable(categoryData);
            } else if (exercise && target.cellIndex === 2) { // Clicked on Exercise
                const exerciseData = historyReportData.filter(item => item.exercise === exercise);
                renderHistoryTable(exerciseData);
            }
        });

        exportButton.addEventListener('click', exportJournal);
        importButton.addEventListener('click', () => importFileInput.click());
        importFileInput.addEventListener('change', handleImportFile);

        mergeButton.addEventListener('click', () => {
            mergeData(importedData);
            importChoiceModal.style.display = 'none';
        });
        replaceButton.addEventListener('click', () => {
            replaceData(importedData);
            importChoiceModal.style.display = 'none';
        });

        mobileMenuToggle.addEventListener('click', () => sidebar.classList.toggle('open'));
        mainContent.addEventListener('click', () => { if (sidebar.classList.contains('open')) sidebar.classList.remove('open'); });
        
        // --- Initial Application Setup ---
        setupWelcome();
        populateNavMenu();
    });
    </script>
</body>
</html>
